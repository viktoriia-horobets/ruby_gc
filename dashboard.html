<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ruby GC Profiler Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
    }
    input[type="file"] {
      margin-bottom: 10px;
    }
    canvas {
      margin-top: 30px;
    }
    .summary {
      background: #f4f4f4;
      padding: 10px;
      margin-top: 20px;
      border-left: 4px solid #007bff;
    }
  </style>
</head>
<body>
  <h2>Ruby GC Profiler Dashboard</h2>
  <p>Upload one or more <code>.csv</code> files generated by your Ruby GC profiler script:</p>
  <input type="file" id="csvFile" accept=".csv" multiple />
  <div id="fileSummary"></div>
  <canvas id="gcPauseChart"></canvas>
  <canvas id="heapUsageChart"></canvas>
  <canvas id="gcSummaryChart"></canvas>
  <canvas id="pauseHistogram"></canvas>

  <script>
    document.getElementById('csvFile').addEventListener('change', function (event) {
      const files = event.target.files;
      if (!files.length) return;

      const allData = [];
      let loaded = 0;
      let fileSummaryHtml = '<h3>Summary</h3>';

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const lines = e.target.result.split('\n').slice(1).filter(line => line.trim() !== '');
          const gcTimes = [], usedMemory = [], totalMemory = [], indexes = [];

          lines.forEach(line => {
            const [index, invokeTime, useSize, totalSize, totalObj, gcTime] = line.split(',');
            indexes.push(Number(index));
            gcTimes.push(Number(gcTime));
            usedMemory.push(Number(useSize));
            totalMemory.push(Number(totalSize));
          });

          const fileName = file.name;
          const totalGc = gcTimes.reduce((a, b) => a + b, 0);
          const avgGc = totalGc / gcTimes.length;
          const maxGc = Math.max(...gcTimes);

          fileSummaryHtml += `<div class="summary">
            <strong>${fileName}</strong><br>
            Total GC Time: ${totalGc.toFixed(2)} ms<br>
            Avg GC Time: ${avgGc.toFixed(2)} ms<br>
            Max GC Pause: ${maxGc.toFixed(2)} ms<br>
            GC Count: ${gcTimes.length}<br>
          </div>`;

          allData.push({ fileName, indexes, gcTimes, usedMemory, totalMemory });
          loaded++;

          if (loaded === files.length) {
            document.getElementById('fileSummary').innerHTML = fileSummaryHtml;
            renderCharts(allData);
          }
        };
        reader.readAsText(file);
      });
    });

    let pauseChart, heapChart, summaryChart, histogramChart;
    function renderCharts(allData) {
      if (pauseChart) pauseChart.destroy();
      if (heapChart) heapChart.destroy();
      if (summaryChart) summaryChart.destroy();
      if (histogramChart) histogramChart.destroy();

      // 1. GC Pause Chart (First file only)
      const ctx1 = document.getElementById('gcPauseChart').getContext('2d');
      pauseChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: allData[0].indexes,
          datasets: [{
            label: `${allData[0].fileName} - GC Pause Time (ms)` ,
            data: allData[0].gcTimes,
            borderColor: 'blue',
            fill: false,
            pointRadius: 3,
            tension: 0.1
          }]
        },
        options: { plugins: { title: { display: true, text: 'GC Pause Time per Collection' } } }
      });

      // 2. Heap Usage Chart
      const ctx2 = document.getElementById('heapUsageChart').getContext('2d');
      heapChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: allData[0].indexes,
          datasets: [
            {
              label: `${allData[0].fileName} - Used Heap (bytes)`,
              data: allData[0].usedMemory,
              borderColor: 'orange',
              fill: false,
              pointRadius: 3,
              tension: 0.1
            },
            {
              label: `${allData[0].fileName} - Total Heap (bytes)`,
              data: allData[0].totalMemory,
              borderColor: 'green',
              fill: false,
              pointRadius: 3,
              tension: 0.1
            }
          ]
        },
        options: { plugins: { title: { display: true, text: 'Heap Memory Usage over GC Passes' } } }
      });

      // 3. Summary Comparison Chart (bar)
      const labels = allData.map(d => d.fileName);
      const totalTimes = allData.map(d => d.gcTimes.reduce((a,b) => a+b, 0));
      const maxPauses = allData.map(d => Math.max(...d.gcTimes));
      const counts = allData.map(d => d.gcTimes.length);

      const ctx3 = document.getElementById('gcSummaryChart').getContext('2d');
      summaryChart = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Total GC Time (ms)', data: totalTimes, backgroundColor: 'steelblue' },
            { label: 'Max GC Pause (ms)', data: maxPauses, backgroundColor: 'tomato' },
            { label: 'GC Count', data: counts, backgroundColor: 'gray' }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Summary Comparison of GC Runs'
            }
          }
        }
      });

      // 4. Histogram of GC Pauses (First file)
      const ctx4 = document.getElementById('pauseHistogram').getContext('2d');
      const bins = Array(10).fill(0);
      const pauses = allData[0].gcTimes;
      const maxVal = Math.max(...pauses);
      const step = maxVal / bins.length;
      pauses.forEach(p => {
        const idx = Math.min(Math.floor(p / step), bins.length - 1);
        bins[idx]++;
      });
      const binLabels = bins.map((_, i) => `${Math.round(i * step)}-${Math.round((i + 1) * step)} ms`);

      histogramChart = new Chart(ctx4, {
        type: 'bar',
        data: {
          labels: binLabels,
          datasets: [{
            label: 'Frequency of GC Pauses',
            data: bins,
            backgroundColor: 'purple'
          }]
        },
        options: {
          plugins: { title: { display: true, text: 'Histogram of GC Pause Durations' } }
        }
      });
    }
  </script>
</body>
</html>
